/* --------------------------------------------------------------------------------------------
 * Copyright (c) Red Hat
 * Licensed under the Apache-2.0 License. See License.txt in the project root for license information.
 * ------------------------------------------------------------------------------------------ */
'use strict';

import { Diagnostic, DiagnosticSeverity } from 'vscode-languageserver';
import { Range } from 'vscode-languageserver';
import { VERSION_PLACEHOLDER } from './constants';
import { IDependencyProvider } from './collector';
import { DependencyData } from './componentAnalysis';
import { RHDA_SOURCE } from './constants';

/* Vulnerability data along with package name and version */
class Vulnerability {
    constructor(
        private provider: IDependencyProvider,
        private range: Range,
        private ref: string,
        private dependencyData: DependencyData[],
        private replacement: string = VERSION_PLACEHOLDER,
      ) {}

    getDiagnostic(): Diagnostic {

        const diagSeverity = DiagnosticSeverity.Error;

        let msg: string = `${this.ref.replace(`pkg:${this.provider.ecosystem}/`, '')}`

        this.dependencyData.forEach(dm => {
            msg += `
            
    ${dm.sourceId} vulnerability info:
    Known security vulnerabilities: ${dm.issuesCount}
    Highest severity: ${dm.highestVulnerabilitySeverity}`;
        });

        return {
            severity: diagSeverity,
            range: this.range,
            message: msg,
            source: RHDA_SOURCE,
        };
    }
}

export { Vulnerability };